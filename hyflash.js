'use strict';
var mindPop_female="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"mindpop_begin mindpop_repeat\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":true,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"irish_woman\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":true,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var mindPop_male="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"mindpop_begin mindpop_repeat\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":true,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"sleepy_man\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":true,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var dollhouse_female="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1.0\",\"show_center_text\":true,\"programs\":\"dollhouse\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"5\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"irish_woman\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":true,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var dollhouse_male="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"dollhouse\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":true,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"sleepy_man\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":true,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var test_female="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"test\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"irish_woman\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":true,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var test_male="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"test\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"sleepy_man\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":true,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var candybimbo_female="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"candybimbo\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"irish_woman\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":true,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var candybimbo_male="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"candybimbo\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"sleepy_man\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":true,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var obedientbimbo_female="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"obedientbimbo\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"irish_woman\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":false,\"spiral14.gif\":false,\"spiral15.gif\":true,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var obedientbimbo_male="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"obedientbimbo\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"sleepy_man\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":false,\"spiral14.gif\":false,\"spiral15.gif\":true,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var planning_female="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"obeyrelax planning wakeupslow\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"5\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0.2\",\"voice\":\"irish_woman\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":true,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":false,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.15\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var neveragain_female="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1.0\",\"show_center_text\":true,\"programs\":\"neveragain\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"5\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"irish_woman\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":true,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var triggerinduction_female="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"induction1 triggerprog\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"irish_woman\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":false,\"spiral14.gif\":false,\"spiral15.gif\":true,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var triggerinduction_male="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"induction1 triggerprog\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"sleepy_man\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":false,\"spiral14.gif\":false,\"spiral15.gif\":true,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var puppet_female="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"puppet puppetstrings rollercoaster forgetresistance acceptpleasure amnesia wakeupunstuck\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":true,\"numProgs\":\"5\",\"triggerprog\":false,\"sprinkles_list\":\"whisper_sprinkles puppet_sprinkles persuade_sprinkles mean_sprinkles\",\"sprinkleProb\":\"0.6\",\"voice\":\"irish_woman\",\"chorus\":false,\"Spiral.gif\":true,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":true,\"spiral12.gif\":true,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":true,\"spiral13.gif\":false,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":true,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"encourage\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.15\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var puppet_male="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"1\",\"show_center_text\":true,\"programs\":\"puppet puppetstrings rollercoaster forgetresistance acceptpleasure amnesia wakeupunstuck\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":true,\"numProgs\":\"5\",\"triggerprog\":false,\"sprinkles_list\":\"whisper_sprinkles puppet_sprinkles persuade_sprinkles mean_sprinkles\",\"sprinkleProb\":\"0.6\",\"voice\":\"sleepy_man\",\"chorus\":false,\"Spiral.gif\":true,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":true,\"spiral12.gif\":true,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":true,\"spiral13.gif\":false,\"spiral14.gif\":false,\"spiral15.gif\":false,\"spiral16.gif\":true,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"encourage\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.15\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var rentaslut_intro_female="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"0.7\",\"show_center_text\":true,\"programs\":\"rentaslut_intro rentaslut_pinkgas rentaslut_outofbody rentaslut_wakeup\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"irish_woman\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":false,\"spiral14.gif\":false,\"spiral15.gif\":true,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var rentaslut_intro_male="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"0.8\",\"show_center_text\":true,\"programs\":\"rentaslut_intro rentaslut_pinkgas rentaslut_outofbody rentaslut_wakeup\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"sleepy_man\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"sleepy_man\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":false,\"spiral14.gif\":false,\"spiral15.gif\":true,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var rentaslut_female="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"0.7\",\"show_center_text\":true,\"programs\":\"rentaslut_intro rentaslut_pinkgas rentaslut_outofbody rentaslut_pinkgas1 rentaslut_outofbody1 rentaslut_pinkgas2 rentaslut_outofbody2 rentaslut_pinkgas3 rentaslut_outofbody3 rentaslut_pinkgas4 rentaslut_outofbody4 rentaslut_pinkgas5 rentaslut_outofbody5 rentaslut_aftermath rentaslut_wakeup\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"irish_woman\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":false,\"spiral14.gif\":false,\"spiral15.gif\":true,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
var rentaslut_male="{\"presets\":\"custom_presets\",\"textdump\":false,\"spreed\":false,\"speedup\":\"0.7\",\"show_center_text\":true,\"programs\":\"rentaslut_intro rentaslut_pinkgas rentaslut_outofbody rentaslut_pinkgas1 rentaslut_outofbody1 rentaslut_pinkgas2 rentaslut_outofbody2 rentaslut_pinkgas3 rentaslut_outofbody3 rentaslut_pinkgas4 rentaslut_outofbody4 rentaslut_pinkgas5 rentaslut_outofbody5 rentaslut_aftermath rentaslut_wakeup\",\"speak_bck\":false,\"bckGain\":\"0.4\",\"voice_bck\":\"irish_woman\",\"programs_bck\":\"\",\"alt_programs\":\"nicer\",\"wake\":false,\"randomize\":false,\"numProgs\":\"100\",\"triggerprog\":false,\"sprinkles_list\":\"\",\"sprinkleProb\":\"0\",\"voice\":\"sleepy_man\",\"chorus\":false,\"Spiral.gif\":false,\"spiral7_horizontal.gif\":false,\"spiral8.gif\":false,\"spiral10.gif\":false,\"spiral11.gif\":false,\"spiral12.gif\":false,\"spiral17.gif\":false,\"spiral18.gif\":false,\"spiral19.gif\":false,\"spiral20.gif\":false,\"spiral21.gif\":false,\"spiral9.gif\":false,\"spiral13.gif\":false,\"spiral14.gif\":false,\"spiral15.gif\":true,\"spiral16.gif\":false,\"only_spiral\":false,\"badcommands\":\"\",\"backgroundSuggestions\":\"none\",\"flashrate\":\"200\",\"binaurals\":true,\"binGain\":\"0.05\",\"binLeft\":\"200\",\"binRight\":\"205\",\"trigger\":\"coconut dreams\",\"triggerText\":\"\",\"randExtras\":\"randExtras\"}";
// HOWTO: I have added comments containing the text "HINT."  These comments are
// meant to allow someone with minimal programming skill to edit the file so
// that it shows the commands they want.  Do a text search in this file for "HINT"
// and follow the instructions you find there.  Save a copy of the file before you
// edit it, so that you can go back to a good version if you mess it up.
// (The file that actually will display must be named hyflash.js however).
// If you ask me for tech support... I'm more likely to help if there is hypnosis
// roleplay involved. That means either you are female and want to force me
// to help you by using my trigger, or you are female submissive and want me
// to trigger you.
//
// To actually display the commands, after you've made and saved your changes here,
// simply double click on the "hyflash.html" file  and open it in your browser.


////////////////////////////////////////////////////////////////////////////////
////// SECTION 1:  subliminals /////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////// HINT: This section contains suggestions to be flashed in the ////////////
////// background. /////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

var obey = ["trance deeper",
            "no will to resist",
            "you let it happen",
            "it feels good",
            "you lose control",
            "you want to do this",
            "you have no choice",
            "your tranced mind doesn't need your permission",
            "your tranced mind can take over at any time",
            "your tranced mind easily overpowers your conscious mind",
            "your tranced mind has so much power",
            "like it or not",
            "you slip deeper into trance",
            "total hypnotic amnesia",
            "your trigger is '#sleeptrigger'"
           ];

var obeyme = ["trance deeper",
              "no will to resist",
              "I let it happen",
              "it feels good",
              "I lose control",
              "I want to do this",
              "I have no choice",
              "My tranced mind doesn't need my permission",
              "My tranced mind can take over at any time",
              "My tranced mind easily overpowers my conscious mind",
              "My tranced mind has so much power",
              "like it or not",
              "I slip deeper into trance",
              "total hypnotic amnesia",
              "My trigger is '#sleeptrigger'"
             ];

var encourage = ["Feeling so good",
                 "Wanting more",
                 "Bliss on every level",
                 "Loving this feeling",
                 "Automatic",
                 "Automatic",
                 "Automatic",
                 "My trigger is '#sleeptrigger'",
                 "Listening again and again",
                 "Deeper into bliss",
                 "Mindless and receptive",
                 "So happy to be deep",
                 "The words feel so good",
                 "Focus and forget",
                 "Amnesia",
                 "Mind so open",
                 "So much pleasure",
                 "Keep coming back",
                 "Listening and enjoying"];

var encourageControl = ["Feeling so good",
                        "Wanting more",
                        "Needing more",
                        "Bliss on every level",
                        "Loving this feeling",
                        "I am a slave to Control",
                        "Listening again and again",
                        "Deeper into bliss",
                        "Mindless and receptive",
                        "So happy to be deep",
                        "The words feel so good",
                        "Focus and forget",
                        "Amnesia",
                        "Mind so open",
                        "So much pleasure",
                        "Keep coming back",
                        "Listening and edging",
                        "Love to condition to obey",
                        "Weaker every day",
                        "Slave must obey",
                        "Cannot think",
                        "Giving up control",
                        "Obedience is pleasure",
                        "Complying with instruction",
                        "Always wanted this",
                        "Love being programmed",
                        "Opening your mind to my words",
                        "No resistance",
                        "Love to be a toy",
                        "Live to serve control"];


var positive = ["trance deeper",
                "I let it happen",
                "feels good to trance",
                "I want to do this",
                "my subconscious accepts the suggestions",
                "The trance doubles every second",
                "my trigger is '#sleeptrigger'",
                "#sleeptrigger",
                "I work out every day",
                "I love to meditate",
                "I get stuff done",
                "I watch this every day",
                "I have great focus",
                "I'm restless unless I'm doing something productive",
                "I know something useful I can do",
                "I sleep well",
                "I breathe well"];

var obeypositive = obeyme.concat(positive);


var meaniesleep = "";


var extraTriggers = ["Are you hypnotized?", "Bambi sleep"];

//var programs = [obeyprog_nopain, healthyprog, acceptpleasureprog_consciouspleasure, rollercoaster3,acceptpleasureprog_consciouspleasure, amnesiaprog_voluntary];

//var programs = [obeyprog_agree, healthyprog, acceptpleasureprog_agree, rollercoaster3_agree, acceptpleasureprog_agree, amnesiaprog_agree];
//var programs = [obeyprog, healthyprog, acceptpleasureprog_nochoice, rollercoaster4, acceptpleasureprog_nochoice, amnesiaprog_agree];
//var programs = [triggerprog_paper, obeyprog, acceptpleasureprog_nochoice, rollercoaster4, acceptpleasureprog_nochoice, amnesiaprog_agree, rollercoaster4, obeyprog, amnesiaprog_agree, acceptpleasureprog_nochoice, triggerprog_paper, rollercoaster4, obeyprog];


////////////////////////////////////////////////////////////////////////////////
/////// SECTION 3:  Choosing the programs. /////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

// HINT: these are special programs
// Every command in them will appear in a random order.
// If you made a new program that should also be scrambled, then
// just add it to this list.
var scrambledPrograms = ["rollercoaster3_agree", "rollercoaster_notwitch", "rollercoaster", "rollercoaster_unsafe", "nicer__rollercoaster", "twitchy", "persuade", "slutty", "work", "controlprogram", "controlprogram_puppet", "robotvocabrandom"];

// These are relaxing programs that should not have twitchy commands inserted
var noTwitchy = ["forestprog", "relaxprog", "wakeupunstuck", "wakeupslow", "wakeupunstuck_simplebot"];

// These are awakeners that go at the end even in a randomized sequence
var awakeners = ["wakeupunstuck", "wakeupunstuck_simplebot", "wakeupslow"];

// These go at the beginning even in a randomized sequence
var beginners = ["mindpop_begin"]

var line = "";

function runCommand(c, refs){ // refs is provided so that a CODE:: line can use them.
    let splitC = c.split("CODE::");
    if (splitC.length > 1){
        line = "X"; // dummy value; won't be added to progression
        let commandName = splitC[1];
        if(window[commandName])
            window[commandName](refs);

        return line; // set by evaluated command
    }
    return c;
}

function pushProgram(progression, p, refs, sprinkles_refs, sprinkles, pName){
    let noTwitchyP = inArray(noTwitchy, pName);
    for(let j=0;j<p.length;j++){
        let snippet = runCommand(p[j], refs);
        if(snippet != "X")
            progression.push(snippet);
        if(sprinkles && sprinkles.length > 0 && !noTwitchyP && Math.random() < sprinkleProb)
        {
            let endsInPeriod = snippet.length>0 && snippet[snippet.length-1] == '.';
            let doesntEndInEllipses = snippet.length<2 || snippet[snippet.length-2] != '.';
            let nextLineBeginsUppercase = j<p.length-1 && p[j+1].length > 0 && p[j+1][0].toLowerCase() != p[j+1][0];
            let endsInSound = snippet.length>1 && snippet[snippet.length-1] == "#" && snippet[snippet.length-2] == "#";
            if(endsInPeriod && doesntEndInEllipses || nextLineBeginsUppercase || endsInSound){
                let index=Math.floor(Math.random() * sprinkles.length);
                let sprinkle = runCommand(sprinkles[index], sprinkles_refs);
                if(sprinkle != "X")
                    progression.push(sprinkle);
            }
        }
    }
}

function pushProgram_bck(p, refs){
    for(let j=0; j < p.length; j++){
        let snippet = runCommand(p[j], refs);
        if (snippet != "X")
            progression_bck.push(snippet);
        // no sprinkles for background
    }
}

function inArray(array, value) {
    var i = array.length;
    while (i--) {
        if (array[i] == value) {
            return true;
        }
    }
    return false;
}

function voiceIsFemale(voice){
    if (voice.match("female"))
        return true
    if (voice.match("woman"))
        return true
    if (voice.match("male"))
        return false
    if (voice.match("man"))
        return false
    alert("Unknown if voice " + voice + " is female");
}

function preprocessProgram(p, refs){
    // run, and remove, any lines beginning with INITCODE::
    let p3 = [];
    for(let j=0; j < p.length; j++){
        let command = p[j];
        if(command.indexOf("INITCODE::") == 0){
            runCommand(command, refs);
        }
        else if(command.indexOf("REF::") != -1){
            // this line was used to trigger speech generation, but won't be
            // used in the program.  presumably some CODE:: line will
            // generate it.
            let cmdSplit = command.split("REF::");
            refs[cmdSplit[0]] = cmdSplit[1];
        }
        else
            p3.push(command);
    }
    refs["voiceIsFemale"] = voiceIsFemale(voice);
    refs["voiceIsMale"] = !voiceIsFemale(voice);
    return p3;
}

var trigger = "coconut dreams";

/*var refs;

  var sprinkles_refs;*/

function getNextProgram(programs, programNames, randomizePrograms, currentProgIndex){
    if (currentProgIndex == -1){
        
    }
}

var programPointer = {"program": -1, "line": -1};
var progressionInfo = {"programs": [], "programNames": []};

function getNextLine(programs, programNames, randomizePrograms, sprinkles, currentProgIndex, currentProgram, currentIndex){
    
}

function preparePrograms(progression, programs, programNames, randomizePrograms, sprinkles){
    let programs_tmp = [];
    let program_names_tmp = [];
    let programs_awaken = [];
    let programs_awaken_names = [];
    let programs_begin = [];
    let programs_begin_names = [];
    // Separate awakeners from other programs
    for(let i=0; i < programs.length; i++){
        let p_ = programs[i];
        if(inArray(awakeners, programNames[i])){
            //alert("awaken " + programNames[i]);
            programs_awaken.push(p_);
            programs_awaken_names.push(programNames[i]);
        }
        else if(inArray(beginners, programNames[i])){
            programs_begin.push(p_);
            programs_begin_names.push(programNames[i]);
        }
        else{
            programs_tmp.push(p_);
            program_names_tmp.push(programNames[i]);
            //alert(programNames[i]);
        }
    }
    programs = programs_tmp;
    programNames = program_names_tmp;

    if (!randomizePrograms){
        numProgs = programs.length;
    }
    let p2 = [];
    let p = p2;
    let pName = "";

    let refs = {};
    let sprinkles_refs = {};
    sprinkles = preprocessProgram(sprinkles, sprinkles_refs);

    if(triggerprogFirst){
        if (triggerprog && triggerprog.length>0){
            let p3 = preprocessProgram(triggerprog, refs);
            pushProgram(progression, p3, refs, sprinkles_refs, sprinkles, "triggerprog");
        }
        else if (triggerprog_mistress && triggerprog_mistress.length > 0){
            let p3 = preprocessProgram(triggerprog_mistress, refs);
            pushProgram(progression, p3, refs, sprinkles_refs, sprinkles, "triggerprog_mistress");
        }
    }
    
    for(let i=0;i<programs_begin.length;i++){
        pushProgram(progression, programs_begin[i], refs, sprinkles_refs, sprinkles, programs_begin_names[i]);
    }

    for(let i=0;i<numProgs;i++){
        let pName = "";
        if (randomizePrograms){
            let iters = 0;
            while(p == p2 && iters < 20){
                let ix = Math.floor(Math.random() * programs.length);
                p = programs[ix];
                pName = programNames[ix];
                if (programs.length == 1)
                    break;
                iters+=1;
            }
            p2 = p;
        }
        else{
            p = programs[i];
            pName = programNames[i];
        }
        refs = {};
        let p3 = preprocessProgram(p, refs);
        if(inArray(scrambledPrograms,pName) || refs.rand){
            let noTwitchyP = inArray(noTwitchy, pName);
            var minrand = refs.min_rand;
            var maxrand = refs.max_rand;
            if (!minrand)
                minrand = 30;
            if (!maxrand)
                maxrand = 60;
            progression.push("#sleeptrigger");
            var j2 = Math.floor(Math.random() * (maxrand - minrand))+minrand;
            var prevIndex = -1;
            var index = -1;
            for(let j=0;j<j2;j++){
                for(let k=0; k < 10; k++){
                    index=Math.floor(Math.random() * p3.length);
                    if (index != prevIndex)
                        break;
                }
                prevIndex = index;
                
                let snippet = runCommand(p3[index], refs);
                if(snippet != "X")
                    progression.push(snippet);
                if(sprinkles && sprinkles.length > 0 && !noTwitchyP && Math.random() < sprinkleProb){
                    let index=Math.floor(Math.random() * sprinkles.length);
                    let snippet = runCommand(sprinkles[index], sprinkles_refs);
                    if(snippet != "X")
                        progression.push(snippet);
                }
            }
            progression.push("wake up")
        }
        else{
            pushProgram(progression, p3, refs, sprinkles_refs, sprinkles, pName);
        }
    }

    for(let i=0;i<programs_awaken.length;i++){
        pushProgram(progression, programs_awaken[i], refs, sprinkles_refs, sprinkles, programs_awaken_names[i]);
    }

    let prog2 = [];
    if (stripWakes)
    {
        let j=0;
        for (let i=0;i<progression.length;i++){
            if ((progression[i].indexOf("wake up") == -1 && progression[i].length > 0) || progression.length - i < 4 || progression[i].length > 10){
                progression[j] = progression[i];
                j++;
            }
        }
        progression.length = j;
    }
    for(let i=0; i < progression.length; i++){
        progression[i] = progression[i].replace(/#sleeptrigger/g,trigger);
    }

}

function encodeUnicode(str) {
  // first we use encodeURIComponent to get percent-encoded UTF-8,
  // then we convert the percent encodings into raw bytes which
  // can be fed into btoa.
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
      function toSolidBytes(match, p1) {
          return String.fromCharCode('0x' + p1);
  }));
}

function decodeUnicode(str) {
  // Going backwards: from bytestream, to percent-encoding, to original string.
  return decodeURIComponent(atob(str).split('').map(function (c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
}

var backgroundSpiralColor = {
    "spiral16.gif": "#f38bbc",
    "spiral17.gif": "#f183af",
    "spiral15.gif": "#ffd5e9",
    "spiral13.gif": "#b33b76",
    "spiral14.gif": "#f5b1cd",
    "spiral9.gif":  "#4e2548",
    "spiral18.gif": "#262626",
    "spiral20.gif": "#f0f1f0",
    "spiral21.gif": "#262626",
    "spiral19.gif": "#060306"
};

// stretch:  spiral will be stretched to fill the whole screen.
// same_aspect: spiral will retain its aspect ratio and be a rectangle.
//      surrounding area will be filled with a solid color
// circle: spiral will be cropped into a circle, retaining its aspect ratio.
//      surrounding area will be filled with a solid color
//
// transparent: spiral is 50% transparent
// transparent_cover_middle: spiral is 50% transparent.  The middle is filled with a black-to-alpha radial gradient.
// masked_1: spiral is image-masked to be opaque in the middle, fading to nothing by the circular border
// masked_2: spiral is image-masked to be opaque in the middle, fading to 50% opacity.  I think I *always* want to do this.
var spiralDisplayModes = {
    "Spiral.gif": "stretch",
    "spiral7_horizontal.gif": "same_aspect",
    "spiral8.gif": "circle",
    "spiral9.gif": "same_aspect",
    "spiral10.gif": "circle",
    "spiral11.gif": "circle",
    "spiral12.gif": "stretch",
    "spiral13.gif": "circle",
    "spiral14.gif": "stretch",
    "spiral15.gif": "circle",
    "spiral16.gif": "same_aspect",
    "spiral17.gif": "circle",
    "spiral18.gif": "same_aspect",
    "spiral19.gif": "same_aspect",
    "spiral20.gif": "circle",
    "spiral21.gif": "same_aspect"
};

var spiral_gif = "";

var speedup=1;
var suggestions = obey;
var textdump = false;
var spreed = false;
var speak = true;
var speak_bck = true;
var voice = "female";
var voice_bck = "Sleepy_woman";
var bckGain = 0.5;

var pain = true; // TODO
var unsafe = false;

var randExtras = [];//rollercoaster.concat(persuade);
//var sprinkles = twitchy.concat(persuade);
var sprinkleProb = 0.2;
var progression = [];
var progression_bck = [];

var randomizePrograms = true;

var avoidCommands = [];

var stripWakes = true;

var programs = [];

var programNames = [];

var programs_bck = [];
var programNames_bck = [];

var numProgs = 10;

var flashrate = 2000;

var nothing = [];

var useBinaurals = true;

var sprinkles = [];

var spiralDisplayMode = "";

var onlySpiral = false;

var chorus = true;
var chorusvoices = ["young_woman", "irish_woman", "sleepy_woman"];

var alt_safe = false;
var alt_nicer = true;
var alt_unsafe = false;
var urlParams = new URLSearchParams(window.location.search);

// presets
/*var puppet_presets = `
{"presets":"puppet_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"puppet puppetstrings rollercoaster forgetresistance work acceptpleasure amnesia wakeupunstuck","pain":false,"unsafe":false,"wake":false,"randomize":true,"numProgs":"5","triggerprog":false,"sprinkles_list":"whisper_sprinkles puppet_sprinkles persuade_sprinkles mean_sprinkles","sprinkleProb":"0.6","voice":"female4","Spiral.gif":true,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":true,"spiral12.gif":true,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":false,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":true,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":true,"only_spiral":false,"badcommands":"","backgroundSuggestions":"obeyself","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;*/

var beginner_presets = `
{"presets":"beginner_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"forestprog relaxprog triggerprog forgetresistance obeyprog amnesia acceptpleasure","alt_programs":"nicer","wake":false,"randomize":false,"numProgs":"5","triggerprog":false,"sprinkles_list":"","sprinkleProb":"0","voice":"female4","Spiral.gif":true,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":true,"spiral12.gif":true,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":false,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":true,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":true,"only_spiral":false,"badcommands":"","backgroundSuggestions":"none","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var notwitch_presets = `
{"presets":"notwitch_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"obeyprog amnesia acceptpleasure forgetresistance rollercoaster","pain":false,"unsafe":false,"wake":false,"randomize":true,"numProgs":"5","triggerprog":false,"sprinkles_list":"whisper_sprinkles persuade_sprinkles","sprinkleProb":"0.4","voice":"female4","Spiral.gif":true,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":true,"spiral12.gif":true,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":false,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":true,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":true,"only_spiral":false,"badcommands":"","backgroundSuggestions":"obeyself","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var slut_presets = `
{"presets":"slut_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"slutty","pain":false,"unsafe":false,"wake":false,"randomize":false,"numProgs":"5","triggerprog":false,"sprinkles_list":"","sprinkleProb":"0","voice":"female4","Spiral.gif":true,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":true,"spiral12.gif":true,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":false,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":true,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":true,"only_spiral":false,"badcommands":"","backgroundSuggestions":"obeyself","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var suckthumbnow_presets = `
{"presets":"suckthumbnow_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"suckthumbnow","pain":false,"unsafe":false,"wake":false,"randomize":false,"numProgs":"5","triggerprog":false,"sprinkles_list":"","sprinkleProb":"0","voice":"female4","Spiral.gif":true,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":true,"spiral12.gif":true,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":false,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":true,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":true,"only_spiral":false,"badcommands":"","backgroundSuggestions":"obeyself","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var hucow_presets = `
{"presets":"custom_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"hucow","pain":false,"unsafe":false,"wake":false,"randomize":false,"numProgs":"5","triggerprog":false,"sprinkles_list":"","sprinkleProb":"0","voice":"female4","Spiral.gif":true,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":true,"spiral12.gif":true,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":false,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":true,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":true,"only_spiral":false,"badcommands":"","backgroundSuggestions":"obeyself","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var control_presets = `
{"presets":"control_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"controlprogram controlprogram controlprogram","alt_programs":"nicer","wake":false,"randomize":true,"numProgs":"5","triggerprog":false,"sprinkles_list":"","sprinkleProb":"0.4","voice":"female4","Spiral.gif":true,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":true,"spiral12.gif":true,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":false,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":true,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":true,"only_spiral":false,"badcommands":"","backgroundSuggestions":"encourageControl","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var puppet_presets = `
{"presets":"puppet_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"puppet puppetstrings rollercoaster forgetresistance acceptpleasure amnesia wakeupunstuck","alt_programs":"nicer","wake":false,"randomize":true,"numProgs":"5","triggerprog":false,"sprinkles_list":"whisper_sprinkles puppet_sprinkles persuade_sprinkles mean_sprinkles","sprinkleProb":"0.6","voice":"female4","Spiral.gif":true,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":true,"spiral12.gif":true,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":false,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":true,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":true,"only_spiral":false,"badcommands":"","backgroundSuggestions":"encourage","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var robot_presets = `
{"presets":"robot_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"robot robotcommands robotvocabrandom rollercoaster forgetresistance work acceptpleasure amnesia wakeupunstuck","alt_programs":"nicer","wake":false,"randomize":true,"numProgs":"5","triggerprog":false,"sprinkles_list":"robot_sprinkles mean_sprinkles","sprinkleProb":"0.6","voice":"female4","Spiral.gif":true,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":true,"spiral12.gif":true,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":false,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":true,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":true,"only_spiral":false,"badcommands":"","backgroundSuggestions":"encourage","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var todo_presets = `
{"presets":"todo_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"todo","alt_programs":"nicer","wake":false,"randomize":false,"numProgs":"5","triggerprog":false,"sprinkles_list":"","sprinkleProb":"0","voice":"female4","Spiral.gif":true,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":true,"spiral12.gif":true,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":false,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":true,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":true,"only_spiral":false,"badcommands":"","backgroundSuggestions":"encourage","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var simplebot_presets = `
{"presets":"simplebot_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"acceptpleasure amnesia forgetresistance puppet rollercoaster wakeupunstuck_simplebot","alt_programs":"nicer","wake":false,"randomize":false,"numProgs":"5","triggerprog":false,"sprinkles_list":"mean_sprinkles persuade_sprinkles simplebot_sprinkles sexy_sprinkles","sprinkleProb":"0.6","voice":"irish_woman","Spiral.gif":false,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":false,"spiral12.gif":false,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":false,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":false,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":true,"only_spiral":false,"badcommands":"","backgroundSuggestions":"encourage","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var productive_presets = `
{"presets":"productive_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"productive_rand","speak_bck":true,"bckGain":"0.4","voice_bck":"voodoo_woman","programs_bck":"productive_rand","alt_programs":"nicer","wake":false,"randomize":true,"numProgs":"5","triggerprog":false,"sprinkles_list":"persuade_sprinkles mean_sprinkles","sprinkleProb":"0","voice":"irish_woman","Spiral.gif":false,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":false,"spiral12.gif":false,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":true,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":false,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":false,"only_spiral":false,"badcommands":"","backgroundSuggestions":"encourage","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var schedule_presets = `{"presets":"work_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"schedule wakeupslow","speak_bck":true,"bckGain":"0.6","voice_bck":"irish_woman","programs_bck":"productive_rand diet","alt_programs":"nicer","wake":false,"randomize":true,"numProgs":"5","triggerprog":false,"sprinkles_list":"persuade_sprinkles mean_sprinkles","sprinkleProb":"0","voice":"young_woman","chorus":false,"Spiral.gif":false,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":false,"spiral12.gif":false,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":true,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":false,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":false,"only_spiral":false,"badcommands":"","backgroundSuggestions":"encourage","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var sexy_presets = `{"presets":"sexy_presets","textdump":false,"spreed":false,"speedup":"1","show_center_text":true,"programs":"amnesia wakeupslow","speak_bck":true,"bckGain":"0.4","voice_bck":"irish_woman","programs_bck":"productive_rand diet","alt_programs":"nicer","wake":false,"randomize":true,"numProgs":"5","triggerprog":false,"sprinkles_list":"mean_sprinkles","sprinkleProb":"0.2","voice":"young_woman","chorus":false,"Spiral.gif":false,"spiral7_horizontal.gif":false,"spiral8.gif":false,"spiral10.gif":false,"spiral11.gif":false,"spiral12.gif":false,"spiral17.gif":false,"spiral18.gif":false,"spiral19.gif":true,"spiral20.gif":false,"spiral21.gif":false,"spiral9.gif":false,"spiral13.gif":false,"spiral14.gif":false,"spiral15.gif":false,"spiral16.gif":false,"only_spiral":false,"badcommands":"","backgroundSuggestions":"encourage","flashrate":"200","binaurals":true,"binGain":"0.15","binLeft":"200","binRight":"205","trigger":"magic sleep now","triggerText":"","randExtras":"randExtras"}
`;

var showCenterText = false;

var triggerprogFirst = false;

function initializeFromForm_presets(presetName){
    importForm(`{"presets":"` + presetName + `"}`);
    let buttonSpan = document.getElementById("customButtons");
    buttonSpan.style="display:none;";
    initializeFromForm();
}

function initializeFromForm(){
    let f = document.forms["config"];

    onlySpiral = f["only_spiral"].checked;

    let x = f["backgroundSuggestions"].value;
    if (x == "none" || onlySpiral)
        suggestions = [""];
    else if (x == "obey")
        suggestions = obey;
    else if (x == "obeyself")
        suggestions = obeyme;
    else if (x == "obeypositive")
        suggestions = obeypositive;
    else if (window[x])
        suggestions = window[x];

    x = f["alt_programs"].value;
    if (x == "safe"){
        alt_safe = true;
        alt_unsafe = false;
        alt_nicer = false;
    }
    else if(x == "unsafe"){
        alt_unsafe = true;
        alt_safe = false;
        alt_nicer = false;
    }
    else if(x == "nicer"){
        alt_nicer = true;
        alt_unsafe = false;
        alt_safe = false;
    }
    
    flashrate = parseFloat(f["flashrate"].value);

    showCenterText = f["show_center_text"].checked && !onlySpiral;

    useBinaurals = f["binaurals"].checked && !onlySpiral;
    leftEarFrequencies = [200];
    rightEarFrequencies = [204,207];
    gainFactor = 0.15;

    if (useBinaurals){
        gainFactor = parseFloat(f["binGain"].value);
        x = f["binLeft"].value;
        x = x.split(/[,\s]+/);
        leftEarFrequencies = [];
        for(let i=0;i<x.length;i++){
            let val = parseFloat(x[i].trim());
            if (isNaN(val)){
                alert("Invalid frequency: " + x[i].trim());
                return false;
            }
            leftEarFrequencies.push(val);
        }
        x = f["binRight"].value;
        x = x.split(/[,\s]+/);
        rightEarFrequencies = [];
        for(let i=0;i<x.length;i++){
            let val = parseFloat(x[i].trim());
            if (isNaN(val)){
                alert("Invalid frequency: " + x[i].trim());
                return false;
            }
            rightEarFrequencies.push(val);
        }
    }

    x = f["voice"].value;
    if (x === "none" || onlySpiral){
        speak = false;
        showCenterText = !onlySpiral;
    }
    else{
        speak = true;
        voice = x;
    }
    chorus = f["chorus"].checked;

    speak_bck = f["speak_bck"].checked;

    x = f["voice_bck"].value;
    voice_bck = x;
    if (x === "none")
        speak_bck = false;

    x = f["trigger"].value;
    if (x == "other")
        trigger = f["triggerText"].value;
    else
        trigger = x;

    textdump = f["textdump"].checked;
    spreed = f["spreed"].checked;
    speedup = parseFloat(f["speedup"].value);
    bckGain = parseFloat(f["bckGain"].value);

    stripWakes = !f["wake"].checked;

    progression = [];
    progression_bck = [];
    triggerprogFirst = f["triggerprog"].checked;
    randomizePrograms = f["randomize"].checked;
    numProgs = parseInt(f["numProgs"].value);
    sprinkleProb = parseFloat(f["sprinkleProb"].value);

    x = f["programs"].value;
    x = x.split(/[,\s]+/);
    programs = [];
    programNames = [];
    for(let i=0;i<x.length;i++){
        let pName = x[i].trim();
        if (pName == "")
            continue;
        if (window[pName]){
            programs.push(window[pName]);
            programNames.push(pName);
        }
        else{
            alert("Misspelled program name: " + pName);
            return false;
        }
    }

    x = f["programs_bck"].value;
    x = x.split(/[,\s]+/);
    programs_bck = [];
    programNames_bck = [];
    for(let i=0;i<x.length;i++){
        let pName = x[i].trim();
        if (pName == "")
            continue;
        if (window[pName]){
            programs_bck.push(window[pName]);
            programNames_bck.push(pName);
        }
        else{
            alert("Misspelled program name: " + pName);
            return false;
        }
    }

    x = f["randExtras"].value;
    if (window[x] && !onlySpiral)
        randExtras = window[x];
    
    if (onlySpiral)
        randExtras = [];

    x = f["sprinkles_list"].value;
    x = x.split(/[,\s]+/);
    sprinkles = [];
    for(let i=0;i<x.length;i++){
        let pName = x[i].trim();
        if (pName == "")
            continue;
        if (window.sprinkle_programs[pName]){
            sprinkles = sprinkles.concat(window.sprinkle_programs[pName]);
        }
        else{
            alert("Misspelled program name: " + pName);
            return false;
        }
    }

    x = f["badcommands"].value;
    x = x.split(/\n/);
    avoidCommands = [];
    for(let i=0;i<x.length;i++){
        if (x[i].trim().length != 0){
            let s = x[i].trim();
            s = s.replace(/ +/g," ")
            avoidCommands.push(s); // TODO validate these
        }
    }
    //return false; // validation error


    f.style="display:none;";
    if (programs.length > 0)
        preparePrograms(progression, programs, programNames, randomizePrograms, sprinkles);
    if (programs_bck.length > 0 && speak_bck){
        preparePrograms(progression_bck, programs_bck, programNames_bck, true, []);
    }
    var spiral = document.getElementById("spiral");
    var spiral_gifs = [];
    var spiral_gif_checkboxes = document.getElementsByClassName("spiral_check");
    for(let i=0; i<spiral_gif_checkboxes.length; i++){
        let spiral_check = spiral_gif_checkboxes[i];
        if(f[spiral_check.name].checked){
            spiral_gifs.push(spiral_check.name);
        }
    }
    spiral_gif = spiral_gifs[Math.floor(Math.random() * spiral_gifs.length)];
    spiral.setAttribute("src", spiral_gif);

    if (spiral_gif in spiralDisplayModes)
        spiralDisplayMode = spiralDisplayModes[spiral_gif];
    else
        spiralDisplayMode = "same_aspect";

    showSuggestions();
    if(!textdump){
        resizeSpiral();
        document.body.setAttribute("class","program");
        let spiralContainer = document.getElementById("spiralContainer");
        spiralContainer.style.display = "";
        centralGradient.style.display = "";
        let spiralColor = "black";
        if (spiral_gif in backgroundSpiralColor)
            spiralColor = backgroundSpiralColor[spiral_gif];
        spiralContainer.style["background-color"] = spiralColor;

        let spiral = document.getElementById("spiral");
        if (spiralDisplayMode == "circle"){
            spiral.style["border-radius"] = "50%";
            // 1/ sqrt(2) = 70.7% is the radial-gradient color stop
            // to fade out the circle smoothly at the border
            // into the background color
            //
            // But we only want the very *center* of the circle to be fully
            // opaque.
            //
            // and we want the total opacity outside the center of the circle
            // to be exactly 50%
            //
            //
            spiral.style["-webkit-mask-image"] = "radial-gradient(white 40%, rgba(0, 0, 0, 0) 70.7%)";
            spiral.style["mask-image"] = "radial-gradient(white 40%, rgba(0, 0, 0, 0) 70.7%)";
            /*spiralContainer.style["-webkit-mask-image"] = "radial-gradient(white 20%, rgba(0, 0, 0, 0.5) 30%)";
              spiralContainer.style["mask-image"] = "radial-gradient(white 20%, rgba(0, 0, 0, 0.5) 30%)";
              spiralContainer.style["opacity"] = "1.0";*/
        }
        else if (spiral_gif == "spiral16.gif"){
            let centralGradient2 = document.getElementById("centralGradient2");
            centralGradient2.style.display = "";
        }

        let textwall = document.getElementById("1");
        textwall.setAttribute("class","textwall");
        if (useBinaurals)
            beginBinaural();
        resizeSpiral();
    }
    return false;
}

function loadPresets(){
    let f = document.forms["config"];
    let presetSelectionName = f["presets"];
    
    // hide invalid presets (presets for which we don't have all the programs)
    let allPresets = document.getElementsByClassName("presetOption");
    for(let i=0; i < allPresets.length; i++){
        let presetRadio = allPresets[i].firstChild;
        let presetName = presetRadio.value;
        let possiblePresets = JSON.parse(window[presetName]);
        let x = possiblePresets["sprinkles_list"];
        x = x.split(/[,\s]+/);
        let ok = true;
        for(let j=0;j<x.length;j++){
            let pName = x[j].trim();
            if (pName == "")
                continue;
            if (!window.sprinkle_programs[pName]){
                ok = false;
                break;
            }
        }
        if (ok){
            let x = possiblePresets["programs"];
            x = x.split(/[,\s]+/);
            for(let j=0;j<x.length;j++){
                let pName = x[j].trim();
                if (pName == "")
                    continue;
                if (!window[pName]){
                    ok = false;
                    break;
                }
            }
        }
        if (!ok){
            allPresets[i].style.display="none";
        }
    }

    let settingSaver = f["setting_saver"];
    if(settingSaver.value != ""){
        importForm(settingSaver.value);
    }
    else{
        let urlPresets = urlParams.getAll('presets');
        if(urlPresets.length > 0){
            let presetName = urlPresets[0];
            if (window[presetName])
                importForm(`{"presets":"` + presetName + `"}`);
        }
        else{
            let base64EncodedPresets = urlParams.getAll("s");
            if (base64EncodedPresets.length > 0){
                let decoded = decodeUnicode(base64EncodedPresets[0]);
                importForm(decoded);
            }
            else{
                if (presetSelectionName.value != "custom_presets")
                    importForm(`{"presets":"` + presetSelectionName.value + `"}`);
            }
        }
    }

    /*if (typeof presets !== 'undefined'){
      importForm(presets);
      //f.style = "display:none;";
      //let b = document.getElementById("presetButton");
      //b.style = "";
      }*/
    formAddListeners();
}

function exportForm(){
    let f = document.forms["config"];
    let f_export = {};
    for(let i=0; i < f.elements.length; i++){
        let el = f[i];
        if (!el.name)
            continue;
        if (el.name == "setting_saver")
            continue;
        if (el.type === 'checkbox'){
            f_export[el.name] = el.checked;
        }
        else{
            f_export[el.name] = f[el.name].value;
        }
    }
    return JSON.stringify(f_export);
}

function exportFormShow(){
    let json = exportForm();
    let box = document.getElementById("exportBox");
    let area = document.getElementById("exportArea");
    let overlay = document.getElementById("overlay");
    area.value = json;
    box.style = "";
    overlay.style = "";
}

function closeExportBox(){
    let box = document.getElementById("exportBox");
    let overlay = document.getElementById("overlay");
    box.style="display:none;";
    overlay.style="display:none;";
}

function checkPresets(){
    let f = document.forms["config"];
    f["presets"].value = "custom_presets";
    f["setting_saver"].value = exportForm();
}

function setPreset(){
    let f = document.forms["config"];
    let x = f["presets"].value;
    if (x != "custom_preset" && window[x]){
        importForm(window[x]);
    }
}

function formAddListeners(){
    let f = document.forms["config"];
    for(let i=0; i < f.elements.length; i++){
        let el = f[i];
        if (!el.name)
            continue;
        if (el.name == "presets")
            el.onchange = setPreset;
        else
            el.onchange = checkPresets;
    }
}


function importForm(s){
    let f_import = JSON.parse(s);
    let f = document.forms["config"];
    if (f_import["presets"] != "Custom" && window[f_import["presets"]]){
        // if the imported string is a preset, use the *current*
        // version of that preset (the version in hyflash.js)
        // and discard the rest of the imported string because it might be
        // out of date.
        s = window[f_import["presets"]];
        f_import = JSON.parse(s);
    }
    for(let i=0; i < f.elements.length; i++){
        let el = f[i];
        //alert(f.elements.length);
        if (!el.name)
            continue;
        if (!(el.name in f_import))
            continue
        if (el.type === 'checkbox'){
            f[el.name].checked = f_import[el.name];
        }
        else{
            f[el.name].value = f_import[el.name];
        }
    }
    f["setting_saver"].value = exportForm();
}

function importFormShow(){
    let json = exportForm();
    let box = document.getElementById("importBox");
    let area = document.getElementById("importArea");
    let overlay = document.getElementById("overlay");
    area.value = "";
    box.style = "";
    overlay.style = "";
}

function closeImportBox(){
    let box = document.getElementById("importBox");
    let overlay = document.getElementById("overlay");
    let area = document.getElementById("importArea");
    box.style="display:none;";
    overlay.style="display:none;";
    if(area.value != "")
        importForm(area.value);
}

function deselectSpirals(){
    let spirals = document.getElementsByClassName("spiral_check");
    for(let i=0; i < spirals.length; i++){
        spirals[i].checked = false;
    }
}

function resizeSpiral(){
    if(spiral_gif == "")
        return; // not ready yet
    let w = window.innerWidth;
    let h = window.innerHeight;
    // before we had the top line at 25px (extra1), the middle (progression) at 125, and the bottom (extra2) at 275,
    // I had #spiral height set to 350 in hyflash.html
    // I had .textwall height set to 340
    let extra1container = document.getElementById("1.5");
    let progressioncontainer = document.getElementById("2");
    let extra2container = document.getElementById("2.5");
    // the height of the fonts for these 3 elements is 32 px
    let fontSizePx = "font-size: " + Math.round(h/350.*32).toString() + "px; ";
    extra1container.style = "width:100%; position:absolute; top:" + Math.round(h/350.*25).toString() + "px; " + fontSizePx;
    progressioncontainer.style = "width:100%; position:absolute; top:" + Math.round(h/350.*125).toString() + "px;" + fontSizePx;
    extra2container.style = "width:100%; position:absolute; top:" + Math.round(h/350.*275).toString() + "px;" + fontSizePx;
    // the height of the background font is 18px
    let fontSizePxBackground = "font-size: " + Math.round(h/350.*18).toString() + "px; ";
    let textwallcontainer = document.getElementById("1");
    textwallcontainer.style = fontSizePxBackground;

    let spiral = document.getElementById("spiral");
    let sTop = 0;
    let sLeft = 0;
    if(spiralDisplayMode == "stretch"){
        spiral.width = w;
        spiral.height = h;
    }
    else{
        let natHeight = spiral.naturalHeight;
        let natWidth = spiral.naturalWidth;
        if(h/w > natHeight/natWidth){
            // window is taller than spiral
            // spiral should be 100% width, proportional height
            spiral.width = w;
            spiral.height = natHeight * w / natWidth;
            sTop = (h - spiral.height)/2;
            spiral.style["margin-top"] = String(sTop) + "px";
            spiral.style["margin-left"]= "0px";
        }
        else{
            // spiral should be 100% height, proportional width
            spiral.height = h;
            spiral.width = natWidth * h / natHeight;
            sLeft = (w - spiral.width) / 2;
            spiral.style["margin-left"] = String(sLeft) + "px";
            spiral.style["margin-top"] = "0px";
        }
    }

    let gradient = document.getElementById("centralGradient");
    if (spiral_gif == "spiral16.gif"){
        // need a radial gradient under each of her 2 eyes
        // 500x281
        // lefteye 109 px from left
        // right eye 109 px from right
        // 123 px from top
        // eye radius 50px
        let gradient2 = document.getElementById("centralGradient2");
        let left1 = sLeft + spiral.width * (109-70)/500.0;
        let top1 = sTop + spiral.height * (123-70)/281.;
        let right1 = w - (left1 + spiral.width * 150 / 500.);
        let bot1 = h - (top1 + spiral.height * 160 / 281.);
        gradient.style["left"] = String(left1) + "px";
        gradient.style["top"] = String(top1) + "px";
        gradient.style["right"] = String(right1) + "px";
        gradient.style["bottom"] = String(bot1) + "px";

        let horizShift = spiral.width * 10 / 500.0;

        gradient2.style["left"] = String(right1 + horizShift) + "px";
        gradient2.style["top"] = String(top1) + "px";
        gradient2.style["right"] = String(left1 - horizShift) + "px";
        gradient2.style["bottom"] = String(bot1) + "px";
        
    }
    else{
        if (h/w > 1){
            gradient.style["left"] = "0px";
            gradient.style["right"] = "0px";
            let mtop = String((h - w) / 2) + "px";
            gradient.style["top"] = mtop;
            gradient.style["bottom"] = mtop;
        }
        else{
            gradient.style["top"] = "0px";
            gradient.style["bottom"] = "0px";
            let mleft = String((w - h) / 2) + "px";
            gradient.style["left"] = mleft;
            gradient.style["right"] = mleft;
        }
    }
}



////////////////////////////////////////////////////////////////////////////////
/////// SECTION 4:  The dirty work /////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
/////// HINT: You don't need to worry about anything from this point on. ///////
////////////////////////////////////////////////////////////////////////////////

var tmphtml = "";
var interval = "";

var progTime = 0; // this says what time we should advance to the next in progression
var progIndex = 0; // this says the current index into the progression array
var progSubIndex = 0; // current word index within progression[progIndex]

var progTime_bck = 0; // this says what time we should advance to the next in progression_bck
var progIndex_bck = 0; // this says the current index into the progression_bck array

function fnv_hash(s){
    var h = 2166136261, i;
    for (i = 0; i < s.length; i++) {
        h = h ^ s.charCodeAt(i);
        h = ((h << 24) + (h * 403)) | 0;
        h = h%0x100000000;
    }
    if (h < 0)
        h += 0x100000000;
    return "" + h;
}

// called from html
function showSuggestions(){
    if (textdump){
        var dump=[];
        for(var i=0; i<progression.length; i++){
            dump.push(progression[i] + "<br>");
        }
        document.getElementById("1").innerHTML = dump.join(" ");
    }
    else{
        interval = setInterval("updateDisplayAll()", flashrate);
        if (programs.length > 0){
            if (spreed){
                //speedup = speedup / 2.0;
                setInterval("doProgression()",50);
            }
            else{
                setInterval("doProgression()",200);
            }
            if (speak_bck){
                setInterval("doProgression_bck()", 200);
            }

            if (useBinaurals){
                setInterval("updateBinaurals()",200);
            }
        }
        //else
        //      interval = setInterval("updateDisplayAll()", 200);
        if(randExtras.length > 0){
            randExtras = preprocessProgram(randExtras, extras_refs);

            setInterval("updateExtra1()",500);
            setInterval("updateExtra2()",250);
        }
    }
}

var extras_refs = {};

function updateExtra1(){
    let extra="X";
    while(extra == "X"){
        extra = randExtras[Math.floor(Math.random() * randExtras.length)];
        extra = runCommand(extra, extras_refs);
    }
    document.getElementById("1.5").innerHTML = '<div id="extra1">' + getDisplaySnippet(extra.replace(/#sleeptrigger/g,trigger)) + "</div>"
}

function updateExtra2(){
    let extra="X";
    while(extra == "X"){
        extra = randExtras[Math.floor(Math.random() * randExtras.length)];
        extra = runCommand(extra, extras_refs);
    }
    document.getElementById("2.5").innerHTML = '<div id="extra2">' + getDisplaySnippet(extra.replace(/#sleeptrigger/g,trigger)) + "</div>"
}


// stop or start the suggestion flashing
// called from nowhere at present, previously onlick from html
function toggleDisplay(){
    if (interval == ""){
        document.body.innerHTML = tmphtml;
        showSuggestions();
    }
    else{
        window.clearInterval(interval)
        interval = "";
        tmphtml = document.body.innerHTML;
        document.body.innerHTML = "";
        progTime = 0;
        progIndex = 0;
        progSubIndex = 0;
        progTime_bck = 0;
        progIndex_bck = 0;
        progSubIndex_bck = 0;
    }
}

function updateDisplayAll(){
    //updateDisplay(suggestions,'norot','1');
    //updateDisplay(suggestions2,'norot','2');
    updateDisplay(suggestions, 'textwall', '');
}
// updates the display for one div
// suggestions = array of suggestions to flash
// available options:
// 'mirror' if the text should be mirrored
// 'norot' if the text should not be rotated
// 'pinwheel' to show the suggestions in a pinwheel
// tagID indicates which tag to update (default = document.body)
function updateDisplay(suggestions, options, tagID){
    var textwall = options.indexOf("textwall");
    if (textwall != -1){
        doTextwall(suggestions);
        return;
    }
    return;
}

var toggle = 0;

function doTextwall(suggestions){
    // pick 100 random suggestions
    var i;
    var wall = [];
    for(i = 0; i < 100; i++){
        var snum = Math.floor(Math.random() * suggestions.length);
        wall.push(suggestions[snum].replace(/#sleeptrigger/g, trigger) + " &nbsp;");
    }
    document.getElementById("1").innerHTML = wall.join(" ");
}

function stripSpaces(s){
    return s.trim().replace(/ +/g," ");
}

function getVoiceFile(progSnippet, voice){
    let filename = progSnippet.replace(/\(|\)|\.|,|"|'|\?|\#|\!/g,"");
    filename = filename.trim()
    filename = filename.replace(/ +/g,"_");
    filename = filename.replace(/:/g,"");
    filename = filename.substr(0,30) + fnv_hash(progSnippet);
    filename = "speech_" + voice + "/" + filename + ".wav";
    return filename;
}

function getDisplaySnippet(progSnippet){
    // eliminate #SAY and the text that follows #SAY
    // eliminate #SHOW but keep the text that follows it
    let displaySnippet = progSnippet.replace(/#SAY[^#]*/g,"");
    displaySnippet = displaySnippet.replace(/#SHOW/g,"");
    // eliminate #silence*
    displaySnippet = displaySnippet.replace(/#silence[0-9.]*/g, "")
    return displaySnippet;
}

var audioReady = function(){
    return true;
};

function doProgression(){
    // now do progression
    if (progTime < new Date().getTime()){
        if (speak && window.isSpeaking && window.isSpeaking())
            return;
        if (!audioReady())
            return;
        if (progIndex >= progression.length){
            location.reload();
            return;
        }
        let progSnippet = progression[progIndex];
        while (inArray(avoidCommands,stripSpaces(progSnippet))){
            progIndex++;
            if (progIndex >= progression.length)
                return;
            progSnippet = progression[progIndex];
        }
        let postIncrement = false;
        if (progIndex < progression.length){
            if (spreed){
                let words = progression[progIndex].split(" ");
                if (progSubIndex < words.length){
                    progSnippet = words[progSubIndex];
                    progSubIndex++;
                }
                else{
                    progSubIndex = 1;
                    progIndex++;
                    if (progIndex < progression.length){
                        words = progression[progIndex].split(" ");
                        if (words.length == 0)
                            progSnippet = "";
                        else
                            progSnippet = words[0];
                    }
                }
            }
            else{
                progSnippet = progression[progIndex];
                postIncrement = true;
            }
        }
        if (progIndex < progression.length){
            if (showCenterText)
                document.getElementById("2").innerHTML = '<div id="progression">' + getDisplaySnippet(progSnippet) + "</div>"
            else
                document.getElementById("2").innerHTML = '<div id="progression"></div>'
            let dur = progSnippet.length * 1000.0 / 3 / speedup;
            if((progression[progIndex].indexOf('agic sleep now') != -1 && progression.length < 20) ||progression[progIndex].indexOf('wake up') != -1)
                dur *= 10;
            progTime = dur + new Date().getTime();
            if (speak){
                //().\\\"'?#!
                let filename = getVoiceFile(progSnippet, voice);
                let myAudio = new Audio(filename);
                myAudio.play()
                myAudio.addEventListener('loadeddata', () => {
                    progTime = myAudio.duration*1000.0/speedup + new Date().getTime();
                    if (speedup > 1)
                        myAudio.playbackRate = speedup;
                    if (chorus){
                        for (let i=0; i < chorusvoices.length; i++){
                            if (chorusvoices[i] == voice)
                                continue;
                            let myAudioChorus = new Audio(getVoiceFile(progSnippet, chorusvoices[i]));
                            myAudioChorus.play();
                            myAudioChorus.addEventListener('loadeddata', () => {
                                myAudioChorus.playbackRate = myAudio.playbackRate * myAudio.duration / myAudioChorus.duration;
                                myAudioChorus.volume = 0.2;
                            });
                        }
                    }
                });
                audioReady = function(){
                    return myAudio.ended;
                };
                //myAudio.play;
            }
            //if (progSnippet == "")
            //  dur = 10000.0/speedup;
            //alert(String(pt) + " " + String(new Date().getTime()) + "  " + String(progTime));
            if (postIncrement)
                progIndex++;
        }
        else{
            document.getElementById("2").innerHTML = '';
            progTime = new Date().getTime() + 10000000;
        }
    }
}

function doProgression_bck(){
    if (progTime_bck < new Date().getTime()){
        if (speak && window.isSpeaking && window.isSpeaking())
            return;
        if (progIndex_bck >= progression_bck.length)
            progIndex_bck = 0; // start again from the beginning
        let progSnippet = progression_bck[progIndex_bck];
        while (inArray(avoidCommands,stripSpaces(progSnippet))){
            progIndex_bck++;
            if (progIndex_bck >= progression_bck.length)
                return;
            progSnippet = progression_bck[progIndex_bck];
        }
        if (progIndex_bck < progression_bck.length){
            progSnippet = progression_bck[progIndex_bck];
            //().\\\"'?#!
            let filename = progSnippet.replace(/\(|\)|\.|,|"|'|\?|\#|\!/g,"");
            filename = filename.trim()
            filename = filename.replace(/ +/g,"_");
            filename = filename.replace(/:/g,"");
            filename = filename.substr(0,30) + fnv_hash(progSnippet);
            filename = "speech_" + voice_bck + "/" + filename + ".wav";
            //alert(filename);
            let myAudio = new Audio(filename);
            myAudio.play()
            myAudio.addEventListener('loadeddata', () => {
                progTime_bck = myAudio.duration*1000.0/speedup + new Date().getTime();
                myAudio.playbackRate = speedup;
                myAudio.volume = bckGain;
            });
            //myAudio.play;
            //if (progSnippet == "")
            //  dur = 10000.0/speedup;
            //alert(String(pt) + " " + String(new Date().getTime()) + "  " + String(progTime));
            progIndex_bck++;
        }
        else{
            progTime_bck = new Date().getTime() + 10000000;
        }
    }
}


function updateBinaurals(){
    twiddleBinaural();
}

function updateDisplayOld(suggestions, delay){
    // pick a random suggestion
    var snum = Math.floor(Math.random() * suggestions.length);
    var rot = Math.floor(Math.random() * 180 + 90);
    rot = 0;
    var r = (rot - 180) * 3.14159 / 180
    var xoffset = Math.floor(Math.random() * 1000);
    var yoffset = Math.floor(Math.random() * 700);
    document.body.innerHTML = '<div style="width:150px; position:absolute; top:' + yoffset + 'px; left:' + xoffset + 'px; -webkit-transform: rotate(' + rot + 'deg)">' + suggestions[snum] + '</div>'
}
